<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NeViS · Forgot Password</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --crimson: #d4001f; --crimson-d: #8a0014;
      --crimson-g: linear-gradient(135deg, #d4001f, #8a0014);
      --bg-deep: #05020a; --bg-card: #0c050f; --bg-field: #130a18;
      --border: rgba(212,0,31,.18); --border-h: rgba(212,0,31,.55);
      --text: #f0e6f0; --text-muted: #8a708a; --text-dim: #5a4560;
      --success: #0fcf7a; --error: #ff4560; --radius: 14px;
      --trans: 0.25s cubic-bezier(.4,0,.2,1);
    }
    body {
      min-height: 100vh;
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-deep); color: var(--text);
      display: flex; align-items: center; justify-content: center;
    }
    .bg-aurora {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background: radial-gradient(ellipse 70% 60% at 50% 0%, rgba(180,0,25,.13) 0%, transparent 60%);
    }
    .bg-grid {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image: linear-gradient(rgba(212,0,31,.04) 1px, transparent 1px), linear-gradient(90deg, rgba(212,0,31,.04) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(ellipse 70% 70% at 50% 50%, black 0%, transparent 100%);
    }
    .page-wrap {
      position: relative; z-index: 2; width: 100%;
      display: flex; align-items: center; justify-content: center; padding: 48px 20px;
    }
    .card {
      width: 100%; max-width: 460px;
      background: var(--bg-card);
      border: 1px solid var(--border); border-radius: 24px; padding: 52px 44px;
      box-shadow: 0 40px 120px rgba(0,0,0,.8), 0 0 50px rgba(212,0,31,.04) inset;
      animation: up .5s cubic-bezier(.16,1,.3,1) both;
    }
    @keyframes up { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

    .logo {
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.4rem;
      background: var(--crimson-g); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; text-decoration: none; display: inline-block; margin-bottom: 28px;
    }

    .icon-wrap {
      width: 64px; height: 64px; border-radius: 18px;
      background: rgba(212,0,31,.1); border: 1px solid rgba(212,0,31,.25);
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 24px;
      font-size: 1.6rem; color: var(--crimson);
    }

    h2 {
      font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 700;
      letter-spacing: -.02em; margin-bottom: 10px;
    }
    .sub { font-size: .9rem; color: var(--text-muted); line-height: 1.55; margin-bottom: 32px; }

    .form { display: flex; flex-direction: column; gap: 18px; }
    .field { display: flex; flex-direction: column; gap: 7px; }
    label { font-size: .78rem; font-weight: 500; letter-spacing: .05em; text-transform: uppercase; color: var(--text-muted); }
    .input-wrap { position: relative; }
    .input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: .85rem; pointer-events: none; transition: color var(--trans); }
    .input-wrap:focus-within .input-icon { color: var(--crimson); }
    input { width: 100%; padding: 13px 16px 13px 42px; background: var(--bg-field); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: .95rem; outline: none; transition: border-color var(--trans), box-shadow var(--trans); }
    input:focus { border-color: var(--border-h); box-shadow: 0 0 0 3px rgba(212,0,31,.12); }
    input::placeholder { color: var(--text-dim); }
    .pw-toggle { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: .85rem; padding: 4px; transition: color var(--trans); }
    .pw-toggle:hover { color: var(--crimson); }

    .alert { padding: 12px 16px; border-radius: var(--radius); font-size: .87rem; display: none; align-items: flex-start; gap: 10px; line-height: 1.4; }
    .alert.show { display: flex; }
    .alert.error { background: rgba(255,69,96,.1); border: 1px solid rgba(255,69,96,.3); color: #ff6070; }
    .alert.success { background: rgba(15,207,122,.1); border: 1px solid rgba(15,207,122,.3); color: #0fcf7a; }
    .alert i { flex-shrink: 0; margin-top: 1px; }

    .btn {
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%; padding: 14px 24px;
      background: var(--crimson-g); border: none; border-radius: var(--radius);
      color: #fff; font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; letter-spacing: .03em;
      cursor: pointer; transition: opacity var(--trans), transform var(--trans), box-shadow var(--trans);
      box-shadow: 0 8px 24px rgba(212,0,31,.3);
    }
    .btn:hover:not(:disabled) { opacity: .92; transform: translateY(-1px); box-shadow: 0 12px 32px rgba(212,0,31,.4); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin .7s linear infinite; display: none; }
    .btn.loading .spinner { display: block; }
    .btn.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .back-link { display: inline-flex; align-items: center; gap: 8px; margin-top: 20px; font-size: .85rem; color: var(--text-muted); text-decoration: none; transition: color var(--trans); }
    .back-link:hover { color: var(--crimson); }

    .pw-reqs { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .req { display: flex; align-items: center; gap: 5px; font-size: .75rem; color: var(--text-dim); transition: color .2s; }
    .req.met { color: var(--success); }
    .req.fail { color: var(--error); }
    .req i { font-size: .7rem; }

    @media (max-width: 480px) {
      .card { padding: 36px 24px; }
    }
  </style>
</head>
<body>
  <div class="bg-aurora"></div>
  <div class="bg-grid"></div>

<audio id="bgMusic" loop>
  <source src="/Music/Login.mp3" type="audio/mpeg">
</audio>

  <div class="page-wrap">
    <div class="card" id="card">
      <!-- Content injected by JS -->
    </div>
  </div>

  <script>
    const API  = 'http://localhost:5000/api';
    const card = document.getElementById('card');
    const params = new URLSearchParams(window.location.search);
    const resetToken = params.get('token');

    /* ─── View: Forgot Password ─── */
    function renderForgot() {
      document.title = 'NeViS · Forgot Password';
      card.innerHTML = `
        <a href="home.html" class="logo">NEVIS</a>
        <div class="icon-wrap"><i class="fas fa-key"></i></div>
        <h2>Reset your password</h2>
        <p class="sub">Enter the email linked to your account and we'll send a reset link. The link expires in 15 minutes.</p>

        <form class="form" id="forgotForm" novalidate>
          <div class="alert error" id="alert"><i class="fas fa-circle-exclamation"></i><span id="alertMsg"></span></div>

          <div class="field">
            <label for="email">Email address</label>
            <div class="input-wrap">
              <input type="email" id="email" placeholder="you@example.com" autocomplete="email" required/>
              <i class="fas fa-envelope input-icon"></i>
            </div>
          </div>

          <button type="submit" class="btn" id="submitBtn">
            <span class="btn-text">Send reset link <i class="fas fa-paper-plane"></i></span>
            <span class="spinner"></span>
          </button>
        </form>
        <a href="Login.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to login</a>
      `;

      document.getElementById('forgotForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const btn   = document.getElementById('submitBtn');
        const alert = document.getElementById('alert');
        const msg   = document.getElementById('alertMsg');

        if (!email) {
          alert.className = 'alert error show'; msg.textContent = 'Please enter your email.'; return;
        }

        btn.classList.add('loading'); btn.disabled = true;
        try {
          await fetch(`${API}/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
          });
          /* Always show success to prevent enumeration */
          alert.className = 'alert success show';
          msg.textContent = 'If that email is registered, a reset link has been sent. Check your inbox.';
          document.getElementById('forgotForm').querySelectorAll('input,button').forEach(el => el.disabled = true);
        } catch {
          alert.className = 'alert error show'; msg.textContent = 'Network error — please try again.';
        } finally {
          btn.classList.remove('loading');
        }
      });
    }

    /* ─── View: Reset Password ─── */
    function renderReset() {
      document.title = 'NeViS · Reset Password';
      card.innerHTML = `
        <a href="home.html" class="logo">NEVIS</a>
        <div class="icon-wrap"><i class="fas fa-lock-open"></i></div>
        <h2>Set new password</h2>
        <p class="sub">Choose a strong password. You'll be signed out of all sessions after updating.</p>

        <form class="form" id="resetForm" novalidate>
          <div class="alert error" id="alert"><i class="fas fa-circle-exclamation"></i><span id="alertMsg"></span></div>

          <div class="field">
            <label for="newPw">New password</label>
            <div class="input-wrap">
              <input type="password" id="newPw" placeholder="Min. 8 characters" autocomplete="new-password" required/>
              <i class="fas fa-lock input-icon"></i>
              <button type="button" class="pw-toggle" id="pwT"><i class="fas fa-eye" id="pwI"></i></button>
            </div>
            <div class="pw-reqs">
              <span class="req" id="r-len"><i class="fas fa-circle"></i> 8+ chars</span>
              <span class="req" id="r-up"><i class="fas fa-circle"></i> Uppercase</span>
              <span class="req" id="r-lo"><i class="fas fa-circle"></i> Lowercase</span>
              <span class="req" id="r-num"><i class="fas fa-circle"></i> Number</span>
            </div>
          </div>

          <div class="field">
            <label for="confPw">Confirm password</label>
            <div class="input-wrap">
              <input type="password" id="confPw" placeholder="Repeat new password" autocomplete="new-password" required/>
              <i class="fas fa-lock-open input-icon"></i>
            </div>
          </div>

          <button type="submit" class="btn" id="submitBtn">
            <span class="btn-text">Update password <i class="fas fa-check"></i></span>
            <span class="spinner"></span>
          </button>
        </form>
        <a href="Login.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to login</a>
      `;

      /* Toggle */
      document.getElementById('pwT').addEventListener('click', () => {
        const inp = document.getElementById('newPw');
        const ic  = document.getElementById('pwI');
        inp.type  = inp.type === 'password' ? 'text' : 'password';
        ic.className = inp.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
      });

      /* Strength reqs */
      const checks = {
        'r-len': v => v.length >= 8,
        'r-up':  v => /[A-Z]/.test(v),
        'r-lo':  v => /[a-z]/.test(v),
        'r-num': v => /\d/.test(v),
      };
      document.getElementById('newPw').addEventListener('input', function () {
        Object.entries(checks).forEach(([id, fn]) => {
          document.getElementById(id).className = `req ${fn(this.value) ? 'met' : (this.value ? 'fail' : '')}`;
        });
      });

      /* Submit */
      document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('newPw').value;
        const confirm     = document.getElementById('confPw').value;
        const btn         = document.getElementById('submitBtn');
        const alertEl     = document.getElementById('alert');
        const msgEl       = document.getElementById('alertMsg');

        function err(m) { alertEl.className = 'alert error show'; msgEl.textContent = m; }

        if (newPassword !== confirm) { err('Passwords do not match.'); return; }
        const allMet = Object.values(checks).every(fn => fn(newPassword));
        if (!allMet) { err('Password does not meet the requirements.'); return; }

        btn.classList.add('loading'); btn.disabled = true;
        try {
          const res  = await fetch(`${API}/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: resetToken, newPassword }),
          });
          const data = await res.json();

          if (!res.ok) { err(data.message || 'Reset failed.'); return; }

          alertEl.className = 'alert success show';
          msgEl.textContent = 'Password updated! Redirecting to login…';
          setTimeout(() => window.location.href = 'Login.html', 1500);
        } catch {
          err('Network error — please try again.');
        } finally {
          btn.classList.remove('loading'); btn.disabled = false;
        }
      });
    }

    /* ─── Route ─── */
    if (resetToken) {
      renderReset();
    } else {
      renderForgot();
    }
  </script>
  <audio id="bgMusic" loop>
  <source src="/Music/Login.mp3" type="audio/mpeg">
</audio>

<button id="musicToggle" class="nv-music-btn" aria-label="Toggle Music">
  <i class="fas fa-music"></i>
</button>

</body>
</html>
